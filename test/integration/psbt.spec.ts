import { networks, payments, Psbt } from 'evrmorejs-lib';
import ECPairFactory from 'ecpair';
import * as ecc from 'tiny-secp256k1';

const ECPair = ECPairFactory(ecc);
const keyPair = ECPair.fromWIF(
  'Kx8CrP9rBUzQ36USMLAcfJgDDAogpPmpG2ejnQhnrEV4bvCptaNP',
  networks.evrmore,
);
const { address } = payments.p2pkh({
  pubkey: keyPair.publicKey,
  network: networks.evrmore,
});

console.log('Address from WIF:', address);

function createTransaction() {
  const utxos = [
    {
      txid: 'c32cb139c2122af0a46000fa2d46351e0801ecd82ebfaac0e9709b4de599e6e3',
      vout: 0,
      value: 1000000,
      nonWitnessUtxo: Buffer.from(
        '0100000003b60d42bf784a41306f6a887e16202f9c7e1d8f5ae28361cc05511bb0f625e93a02000000fdfd0000483045022100bc6f12f80954af05bd0f66baa115fe2366070b7afe039e5b7826f79bcde2750d0220399b7cc4d38f7cd60132ae13b737d82a4a8f9b6479be876b449181c161c34cd30147304402207666d0fc792c458e28a4135cdf7dea53551c65369597c80a81cb35ffc6dcab5402206d82d58b6a76d27b3f6a530bd823057060dedd73512e1ff7ebbc8dc87c1bbd61014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff5508029261c0ea64e77f4b5105f3a3a0538a0d6414c80f71b1217621c51a3c1c00000000fc00463043021f2630e4daf764c221353557123c85b7d8822e0d0e22485c2e3ab49da179b18b022062374c744be844b8097eeda6a221e3571e9484b3a53f1fb2bd0f65897fad4f2301483045022100b3ec22d147d282738ac4e86d54621b02ab297a88af0c0d41554b88a50d90a5e102204c01d52fad4b24d370254ad1212618327ec70561cf1c290236b7ee913d50a3b8014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff3216fca03713aa044a216209434955edddb27564d445e3ddcec1ab233c6463e800000000fc0047304402200c27912f1272eb6622631f0de07c5fd4e9ab29f8910f895cd068e0929eb92f9b022074a1f0c3062a83c6b832d568a96ded66e0a2be91e225f27ebacc13ec352ba4910147304402204de554f2da22ed6f9fd2840adb6f0b37a0cbdd2b064a692f7f1242f4d793ecbe0220379e5bef906d860e64b62f09fddbe5414f914562385f5f82400b48c2113bb675014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f5249808d5b000000000075705205010000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f524940420f00000000007500000000',
        'hex',
      ),
    },
    {
      txid: 'c32cb139c2122af0a46000fa2d46351e0801ecd82ebfaac0e9709b4de599e6e3',
      vout: 1,
      value: 0,
      nonWitnessUtxo: Buffer.from(
        '0100000003b60d42bf784a41306f6a887e16202f9c7e1d8f5ae28361cc05511bb0f625e93a02000000fdfd0000483045022100bc6f12f80954af05bd0f66baa115fe2366070b7afe039e5b7826f79bcde2750d0220399b7cc4d38f7cd60132ae13b737d82a4a8f9b6479be876b449181c161c34cd30147304402207666d0fc792c458e28a4135cdf7dea53551c65369597c80a81cb35ffc6dcab5402206d82d58b6a76d27b3f6a530bd823057060dedd73512e1ff7ebbc8dc87c1bbd61014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff5508029261c0ea64e77f4b5105f3a3a0538a0d6414c80f71b1217621c51a3c1c00000000fc00463043021f2630e4daf764c221353557123c85b7d8822e0d0e22485c2e3ab49da179b18b022062374c744be844b8097eeda6a221e3571e9484b3a53f1fb2bd0f65897fad4f2301483045022100b3ec22d147d282738ac4e86d54621b02ab297a88af0c0d41554b88a50d90a5e102204c01d52fad4b24d370254ad1212618327ec70561cf1c290236b7ee913d50a3b8014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff3216fca03713aa044a216209434955edddb27564d445e3ddcec1ab233c6463e800000000fc0047304402200c27912f1272eb6622631f0de07c5fd4e9ab29f8910f895cd068e0929eb92f9b022074a1f0c3062a83c6b832d568a96ded66e0a2be91e225f27ebacc13ec352ba4910147304402204de554f2da22ed6f9fd2840adb6f0b37a0cbdd2b064a692f7f1242f4d793ecbe0220379e5bef906d860e64b62f09fddbe5414f914562385f5f82400b48c2113bb675014c69522103b09319bfaebf50c353c72c34a32d58265751842b7817b8d452e87cec5431de772102a587b1cf3ef003b0662b167da5cdd2c908ca84af1298a9f3a9c7a33ce2a848cc2102126c7a85c29a53c9066574dde31762cea724c3cacf0fbd6ce7fb00315847992c53aeffffffff0440420f00000000001976a91431b935055f9bcb2fd2192a932c449c5f0f5291e088ac00000000000000002f76a91431b935055f9bcb2fd2192a932c449c5f0f5291e088acc01365767274065341544f5249808d5b000000000075705205010000000017a91488784d7ed1f337eb57d01162d0ab4014c6598c0a8700000000000000002da91488784d7ed1f337eb57d01162d0ab4014c6598c0a87c01365767274065341544f524940420f00000000007500000000',
        'hex',
      ),
    },
  ];

  const psbt = new Psbt({ network: networks.evrmore });

  utxos.forEach(utxo => {
    psbt.addInput({
      hash: utxo.txid,
      index: utxo.vout,
      nonWitnessUtxo: utxo.nonWitnessUtxo,
    });
  });

  psbt.addOutput({
    address: 'EMgpUQ8ucUSnZnrpYvD2n7na48LfSbZHti',
    value: 600000,
  });

  psbt.addOutput({
    address: 'EQ2dsWBZAJCUJsNTFm1aDY4BQHXTmFRGK5',
    value: 0,
    asset: { name: 'SATORI', amount: 6000000 },
  });

  utxos.forEach((_, index) => {
    try {
      psbt.signInput(index, keyPair);
    } catch (error) {
      console.error(`Error signing input ${index}:`, error);
    }
  });

  try {
    psbt.finalizeAllInputs();
  } catch (error) {
    console.error('Error finalizing inputs:', error);
  }

  const tx = psbt.extractTransaction();
  const txHex = tx.toHex();
  console.log('Transaction Hex:', txHex);

  return txHex;
}

createTransaction();
